<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ruleta Casino PRO</title>

<link rel="apple-touch-icon" sizes="1024x1024" href="icono.png">

<style>
body{
    margin:0;
    font-family:Arial, sans-serif;
    text-align:center;
    background: radial-gradient(circle at top,#1b2a49,#0f172a);
    color:white;
}

h1{margin-top:20px;}

input{
    padding:10px;
    margin:5px;
    border-radius:8px;
    border:none;
    width:200px;
}

button{
    padding:10px 20px;
    margin:10px;
    border:none;
    border-radius:8px;
    font-weight:bold;
    cursor:pointer;
}

#agregar{background:#16a34a;color:white;}
#iniciar{background:#facc15;}
#limpiar{background:#dc2626;color:white;}

#resultado{
    font-size:30px;
    margin-top:20px;
    font-weight:bold;
    min-height:40px;
    transition: all .3s;
}

.ruleta-wrapper{
    position: relative;
    width: 350px;
    height: 350px;
    margin: 20px auto 0;
}

canvas{
    background:white;
    border-radius:50%;
}

.puntero{
    position: absolute;
    top: -6px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 14px solid transparent;
    border-right: 14px solid transparent;
    border-bottom: 22px solid #ef4444;
    filter: drop-shadow(0 2px 2px rgba(0,0,0,.5));
    z-index: 2;
}
</style>
</head>
<body>

<h1>ðŸŽ° Ruleta Casino PRO</h1>

<input id="nombre" placeholder="Nombre">
<input id="numero" placeholder="NÃºmero" type="number">
<button id="agregar">Agregar</button>

<div>
<button id="iniciar">Iniciar Ruleta</button>
<button id="limpiar">Limpiar Lista</button>
</div>

<div class="ruleta-wrapper">
  <div class="puntero"></div>
  <canvas id="ruleta" width="350" height="350"></canvas>
</div>

<div id="resultado"></div>

<script>
let lista = JSON.parse(localStorage.getItem("lista_ruleta")) || [];
const canvas = document.getElementById("ruleta");
const ctx = canvas.getContext("2d");

let girando=false;
let anguloActual=0;
let indiceSeleccionado = -1;

const CX = 175, CY = 175, R = 170;
const TEXT_R_CENTER = R - 60;
const PUNTERO_ANG = -Math.PI/2;

/* ========= AUDIO TIC ========= */
let audioCtx = null;
function initAudio(){
  if (!audioCtx) {
    const AC = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AC();
  }
  if (audioCtx.state === 'suspended') audioCtx.resume();
}

/* ========= TEXTO ========= */
function drawFittedCenteredText(ctx, text, centerRadius){
  ctx.font = "16px Arial";
  ctx.fillStyle = "white";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText(text, centerRadius, 0);
}

function guardar(){
    localStorage.setItem("lista_ruleta",JSON.stringify(lista));
}

function dibujar(){
    ctx.clearRect(0,0,350,350);
    if(lista.length===0) return;

    const angulo = 2*Math.PI/lista.length;

    for(let i=0;i<lista.length;i++){
        ctx.beginPath();
        ctx.moveTo(CX,CY);
        ctx.arc(CX,CY,R,i*angulo,(i+1)*angulo);
        ctx.fillStyle = `hsl(${i*360/lista.length},70%,50%)`;
        ctx.fill();

        ctx.save();
        ctx.translate(CX,CY);
        ctx.rotate(i*angulo + angulo/2);
        drawFittedCenteredText(ctx, lista[i].nombre, TEXT_R_CENTER);
        ctx.restore();

        if (i === indiceSeleccionado) {
            ctx.lineWidth = 6;
            ctx.strokeStyle = "#fde047";
            ctx.beginPath();
            ctx.arc(CX, CY, R-10, i*angulo, (i+1)*angulo);
            ctx.stroke();
        }
    }

    ctx.beginPath();
    ctx.lineWidth = 4;
    ctx.strokeStyle = "#0f172a";
    ctx.arc(CX, CY, R, 0, 2*Math.PI);
    ctx.stroke();
}

function redibujarConRotacion(){
    ctx.save();
    ctx.clearRect(0,0,350,350);
    ctx.translate(CX,CY);
    ctx.rotate(anguloActual);
    ctx.translate(-CX,-CY);
    dibujar();
    ctx.restore();
}

redibujarConRotacion();

/* ========= AGREGAR ========= */
document.getElementById("agregar").onclick=function(){
    const nombre=document.getElementById("nombre").value.trim();
    const numero=document.getElementById("numero").value.trim();

    if(!nombre || !numero){
        alert("Completa los datos");
        return;
    }

    if(lista.some(x=>x.numero==numero)){
        alert("Ese nÃºmero ya fue agregado");
        return;
    }

    lista.push({nombre,numero});
    guardar();
    redibujarConRotacion();

    document.getElementById("nombre").value="";
    document.getElementById("numero").value="";
};

/* ========= LIMPIAR LISTA CON CONFIRMACIÃ“N ========= */
document.getElementById("limpiar").onclick=function(){

    if(!confirm("Â¿Seguro que deseas borrar toda la lista?")) return;

    lista = [];
    guardar();

    indiceSeleccionado = -1;
    anguloActual = 0;

    redibujarConRotacion();

    document.getElementById("resultado").innerText = "";
};

/* ========= MOSTRAR NOMBRE ========= */
function mostrarNombreAntesDeGirar(nombre){
    document.getElementById("resultado").innerText = "ðŸŽ¯ " + nombre;
}

/* ========= GIRAR ========= */
function girarYSeleccionar(index, callback){
    if (girando) return;
    girando = true;

    const n = lista.length;
    const anguloSeg = 2*Math.PI/n;
    const vueltas = 6;
    const duracion = 3000;

    const anguloCentro = index*anguloSeg + anguloSeg/2;
    const delta = (PUNTERO_ANG - anguloCentro);

    const inicio = performance.now();

    function animar(t){
        let p = (t - inicio)/duracion;
        if(p>1) p=1;

        anguloActual = delta*p + vueltas*2*Math.PI*p;
        redibujarConRotacion();

        if(p<1) requestAnimationFrame(animar);
        else{
            indiceSeleccionado = index;
            redibujarConRotacion();
            girando = false;
            callback(index);
        }
    }

    requestAnimationFrame(animar);
}

/* ========= INICIAR ========= */
document.getElementById("iniciar").onclick=async function(){

    if(lista.length < 3){
        alert("Necesitas mÃ­nimo 3 participantes");
        return;
    }

    initAudio();

    let copia=[...lista];

    for(let i=0;i<3;i++){

        const index = Math.floor(Math.random()*copia.length);
        const elegido = copia[index];

        mostrarNombreAntesDeGirar(elegido.nombre);
        await new Promise(r=>setTimeout(r,3000));

        await new Promise(resolve=>{
            girarYSeleccionar(index, seleccionado=>{
                const e=copia[seleccionado];

                if(i<2){
                    document.getElementById("resultado").innerText=e.nombre+" - FUERA âŒ";
                    copia.splice(seleccionado,1);
                    indiceSeleccionado=-1;
                }else{
                    document.getElementById("resultado").innerText="ðŸ† "+e.nombre+" GANADOR ðŸŽ‰";
                }
                resolve();
            });
        });

        if(i<2){
            lista=copia;
            guardar();
            redibujarConRotacion();
            await new Promise(r=>setTimeout(r,4000));
        }
    }
};
</script>

</body>
</html>
