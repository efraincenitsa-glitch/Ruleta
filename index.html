<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ruleta Casino PRO</title>

<link rel="apple-touch-icon" sizes="1024x1024" href="icono.png">

<style>
body{
    margin:0;
    font-family:Arial, sans-serif;
    text-align:center;
    background: radial-gradient(circle at top,#1b2a49,#0f172a);
    color:white;
}
h1{margin-top:20px;}
input{
    padding:10px;
    margin:5px;
    border-radius:8px;
    border:none;
    width:200px;
}
button{
    padding:10px 20px;
    margin:10px;
    border:none;
    border-radius:8px;
    font-weight:bold;
    cursor:pointer;
}
#agregar{background:#16a34a;color:white;}
#iniciar{background:#facc15;}
#limpiar{background:#dc2626;color:white;}
#resultado{
    font-size:30px;
    margin-top:20px;
    font-weight:bold;
    min-height:40px;
}
.ruleta-wrapper{
    position: relative;
    width: 350px;
    height: 350px;
    margin: 20px auto 0;
}
canvas{
    background:white;
    border-radius:50%;
}
.puntero{
    position: absolute;
    top: -6px;
    left: 50%;
    transform: translateX(-50%);
    border-left: 14px solid transparent;
    border-right: 14px solid transparent;
    border-bottom: 22px solid #ef4444;
    z-index: 2;
}
</style>
</head>
<body>

<h1>ðŸŽ° Ruleta Casino PRO</h1>

<input id="nombre" placeholder="Nombre">
<input id="numero" placeholder="NÃºmero" type="number">
<button id="agregar">Agregar</button>

<div>
<button id="iniciar">Iniciar Ruleta</button>
<button id="limpiar">Limpiar Lista</button>
</div>

<div class="ruleta-wrapper">
  <div class="puntero"></div>
  <canvas id="ruleta" width="350" height="350"></canvas>
</div>

<div id="resultado"></div>

<script>
let lista = JSON.parse(localStorage.getItem("lista_ruleta")) || [];
const canvas = document.getElementById("ruleta");
const ctx = canvas.getContext("2d");

let girando=false;
let anguloActual=0;
let indiceSeleccionado = -1;

const CX = 175, CY = 175, R = 170;
const TEXT_R_CENTER = R - 60;
const PUNTERO_ANG = -Math.PI/2;

function guardar(){
 localStorage.setItem("lista_ruleta",JSON.stringify(lista));
}

/* ===== DIBUJAR ===== */
function dibujar(){
 ctx.clearRect(0,0,350,350);
 if(lista.length===0) return;

 const ang=2*Math.PI/lista.length;

 for(let i=0;i<lista.length;i++){

  ctx.beginPath();
  ctx.moveTo(CX,CY);
  ctx.arc(CX,CY,R,i*ang,(i+1)*ang);
  ctx.fillStyle=`hsl(${i*360/lista.length},70%,50%)`;
  ctx.fill();

  ctx.save();
  ctx.translate(CX,CY);
  ctx.rotate(i*ang+ang/2);
  ctx.fillStyle="white";
  ctx.textAlign="center";
  ctx.font="16px Arial";
  ctx.fillText(lista[i].nombre,R-60,0);
  ctx.restore();

  if(i===indiceSeleccionado){
    ctx.lineWidth=6;
    ctx.strokeStyle="#fde047";
    ctx.beginPath();
    ctx.arc(CX,CY,R-10,i*ang,(i+1)*ang);
    ctx.stroke();
  }
 }

 ctx.lineWidth=4;
 ctx.strokeStyle="#0f172a";
 ctx.beginPath();
 ctx.arc(CX,CY,R,0,2*Math.PI);
 ctx.stroke();
}

function redibujar(){
 ctx.save();
 ctx.translate(CX,CY);
 ctx.rotate(anguloActual);
 ctx.translate(-CX,-CY);
 dibujar();
 ctx.restore();
}

redibujar();

/* ===== AGREGAR ===== */
agregar.onclick=function(){
 const n=nombre.value.trim();
 const num=numero.value.trim();
 if(!n||!num) return alert("Completa datos");

 if(lista.some(x=>x.numero==num))
  return alert("NÃºmero repetido");

 lista.push({nombre:n,numero:num});
 guardar();
 redibujar();

 nombre.value="";
 numero.value="";
};

/* ===== LIMPIAR ===== */
limpiar.onclick=function(){
 if(!confirm("Â¿Seguro que deseas borrar toda la lista?")) return;

 lista=[];
 guardar();
 indiceSeleccionado=-1;
 anguloActual=0;
 redibujar();
 resultado.innerText="";
};

/* ===== MOSTRAR NOMBRE ===== */
function mostrarNombreAntesDeGirar(nombre){
 resultado.innerText="ðŸŽ¯ "+nombre;
}

/* ===== GIRAR CORRECTO ===== */
function girarYSeleccionar(index, callback){

 if(girando) return;
 girando=true;

 const n=lista.length;
 const ang=2*Math.PI/n;

 const centro=index*ang+ang/2;

 // ðŸ”¥ CLAVE: considerar rotaciÃ³n actual
 let delta=PUNTERO_ANG - (centro + anguloActual);

 const vueltas=6;
 delta += vueltas*2*Math.PI;

 const dur=3000;
 const inicio=performance.now();

 function anim(t){
  let p=(t-inicio)/dur;
  if(p>1)p=1;

  anguloActual += delta*(1/dur)*16;
  redibujar();

  if(p<1) requestAnimationFrame(anim);
  else{
    indiceSeleccionado=index;
    redibujar();
    girando=false;
    callback(index);
  }
 }

 requestAnimationFrame(anim);
}

/* ===== INICIAR ===== */
iniciar.onclick=async function(){

 if(lista.length<3)
  return alert("Necesitas mÃ­nimo 3 participantes");

 let copia=[...lista];

 for(let i=0;i<3;i++){

  const index=Math.floor(Math.random()*copia.length);
  const elegido=copia[index];

  mostrarNombreAntesDeGirar(elegido.nombre);
  await new Promise(r=>setTimeout(r,3000));

  await new Promise(res=>{
   girarYSeleccionar(index,sel=>{
    const e=copia[sel];

    if(i<2){
     resultado.innerText=e.nombre+" - FUERA âŒ";
     copia.splice(sel,1);
     indiceSeleccionado=-1;
    }else{
     resultado.innerText="ðŸ† "+e.nombre+" GANADOR ðŸŽ‰";
    }

    res();
   });
  });

  if(i<2){
   lista=copia;
   guardar();
   redibujar();
   await new Promise(r=>setTimeout(r,4000));
  }
 }
};
</script>
</body>
</html>
