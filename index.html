<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ruleta Casino PRO</title>

<link rel="apple-touch-icon" sizes="1024x1024" href="icono.png" />

<style>
  body{
      margin:0;
      font-family:Arial, sans-serif;
      text-align:center;
      background: radial-gradient(circle at top,#1b2a49,#0f172a);
      color:white;
  }

  h1{margin-top:20px;}

  input{
      padding:10px;
      margin:5px;
      border-radius:8px;
      border:none;
      width:200px;
  }

  button{
      padding:10px 20px;
      margin:10px;
      border:none;
      border-radius:8px;
      font-weight:bold;
      cursor:pointer;
  }

  #agregar{background:#16a34a;color:white;}
  #iniciar{background:#facc15;}
  #limpiar{background:#dc2626;color:white;}

  #resultado{
      font-size:32px;
      margin-top:20px;
      font-weight:bold;
      min-height:40px;
  }

  .ruleta-wrapper{
      position: relative;
      width: 360px;
      height: 360px;
      margin: 20px auto 0;
  }

  canvas{
      background:white;
      border-radius:50%;
      box-shadow:0 0 20px #000;
  }

  .puntero{
      position:absolute;
      top:-6px;
      left:50%;
      transform:translateX(-50%);
      width:0;height:0;
      border-left:14px solid transparent;
      border-right:14px solid transparent;
      border-bottom:22px solid #ef4444;
      z-index:2;
  }

  /* LED giratorio */
  .ruleta-wrapper::before{
      content:"";
      position:absolute;
      inset:-12px;
      border-radius:50%;
      background:conic-gradient(
          red, yellow, lime, cyan, blue, magenta, red
      );
      animation:led 2s linear infinite;
      z-index:-1;
  }

  @keyframes led{
      from{transform:rotate(0deg);}
      to{transform:rotate(360deg);}
  }

  /* Pantalla ganador gigante */
  #pantallaGanador{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.9);
      display:none;
      align-items:center;
      justify-content:center;
      font-size:64px;
      font-weight:bold;
      color:#fde047;
      text-align:center;
      z-index:999;
  }
</style>
</head>
<body>

<h1>ðŸŽ° Ruleta Casino PRO</h1>

<input id="nombre" placeholder="Nombre" />
<input id="numero" placeholder="NÃºmero" type="number" />
<button id="agregar">Agregar</button>

<div>
  <button id="iniciar">Iniciar Ruleta</button>
  <button id="limpiar">Limpiar Lista</button>
</div>

<div class="ruleta-wrapper">
  <div class="puntero"></div>
  <canvas id="ruleta" width="360" height="360"></canvas>
</div>

<div id="resultado"></div>

<div id="pantallaGanador"></div>

<script>
/* ====== REFERENCIAS A ELEMENTOS ====== */
const canvas = document.getElementById("ruleta");
const ctx = canvas.getContext("2d");
const nombreInput = document.getElementById("nombre");
const numeroInput = document.getElementById("numero");
const agregar = document.getElementById("agregar");
const iniciar = document.getElementById("iniciar");
const limpiar = document.getElementById("limpiar");
const resultado = document.getElementById("resultado");
const pantallaGanador = document.getElementById("pantallaGanador");

/* ====== ESTADO ====== */
let lista = JSON.parse(localStorage.getItem("lista_ruleta")) || [];
let girando = false;
let anguloActual = 0;     // RotaciÃ³n acumulada de la ruleta
let indiceSeleccionado = -1;

const CX=180, CY=180, R=170;
const PUNTERO_ANG=-Math.PI/2; // El puntero mira hacia arriba

function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

/* ===== VOZ CASINO ===== */
function hablar(texto, velocidad=0.9, tono=1){
  const msg=new SpeechSynthesisUtterance(texto);
  msg.lang="es-MX";
  msg.rate=velocidad;
  msg.pitch=tono;
  speechSynthesis.cancel();
  speechSynthesis.speak(msg);
}

function guardar(){
  localStorage.setItem("lista_ruleta", JSON.stringify(lista));
}

/* ===== DIBUJAR ===== */
function dibujar(){
  ctx.clearRect(0,0,360,360);
  if(lista.length===0) return;

  const ang=2*Math.PI/lista.length;

  for(let i=0;i<lista.length;i++){
    ctx.beginPath();
    ctx.moveTo(CX,CY);
    ctx.arc(CX,CY,R, i*ang, (i+1)*ang);
    ctx.fillStyle=`hsl(${i*360/lista.length},70%,50%)`;
    ctx.fill();

    // Etiqueta
    ctx.save();
    ctx.translate(CX,CY);
    ctx.rotate(i*ang + ang/2);
    ctx.fillStyle="white";
    ctx.textAlign="center";
    ctx.font="16px Arial";
    ctx.fillText(lista[i].nombre, R-60, 0);
    ctx.restore();
  }
}

function redibujar(){
  ctx.save();
  ctx.clearRect(0,0,360,360);
  ctx.translate(CX,CY);
  ctx.rotate(anguloActual);
  ctx.translate(-CX,-CY);
  dibujar();
  ctx.restore();
}

// Inicial
redibujar();

/* ===== AGREGAR ===== */
agregar.onclick=function(){
  const nombre = nombreInput.value.trim();
  const numero = numeroInput.value.trim();
  if(!nombre || !numero) return alert("Completa los datos");

  if(lista.some(x => x.numero == numero))
    return alert("NÃºmero duplicado");

  lista.push({ nombre, numero });
  guardar();
  redibujar();

  nombreInput.value = "";
  numeroInput.value = "";
};

/* ===== LIMPIAR ===== */
limpiar.onclick=function(){
  if(!confirm("Â¿Seguro que deseas borrar toda la lista?")) return;
  lista=[];
  guardar();
  indiceSeleccionado=-1;
  anguloActual=0;
  redibujar();
  resultado.innerText="";
};

/* ===== GIRAR (ajustado para caer EXACTO en el segmento) ===== */
function girar(index){
  return new Promise(resolve=>{
    const n = lista.length;
    const angSeg = 2*Math.PI/n;
    const centro = index*angSeg + angSeg/2;      // centro del segmento elegido (en sistema sin rotaciÃ³n)
    const objetivoBase = PUNTERO_ANG - centro;   // Ã¡ngulo que al aplicar dejarÃ¡ el centro bajo el puntero

    const dosPI = 2*Math.PI;
    const inicio = anguloActual;
    // Diferencia normalizada entre el objetivo y la rotaciÃ³n actual
    let diff = (objetivoBase - (inicio % dosPI));
    diff = (diff % dosPI + dosPI) % dosPI;       // [0, 2Ï€)

    const vueltas = 6;        // vueltas extra
    const dur = 3000;         // ms
    const final = inicio + vueltas*dosPI + diff;

    const t0 = performance.now();

    function easeOutCubic(p){ return 1 - Math.pow(1-p,3); }

    function frame(t){
      let p = Math.min(1, (t - t0) / dur);
      const eased = easeOutCubic(p);

      anguloActual = inicio + (final - inicio)*eased;
      redibujar();

      if(p < 1){
        requestAnimationFrame(frame);
      }else{
        // Ensamblar en [0, 2Ï€) para que no crezca indefinidamente
        anguloActual = ((final % dosPI) + dosPI) % dosPI;
        redibujar();
        resolve();
      }
    }
    requestAnimationFrame(frame);
  });
}

/* ===== INICIAR ===== */
iniciar.onclick = async function(){
  if(girando) return;
  if(lista.length < 3) return alert("Necesitas mÃ­nimo 3 participantes");

  girando = true;

  // Hacemos 3 giros:
  for(let i=0; i<3; i++){
    // Elegimos Ã­ndice sobre la lista ACTUAL mostrada
    const index = Math.floor(Math.random() * lista.length);

    // NO mostramos aÃºn nombre â€” primero giramos
    await girar(index);

    // La ruleta ya se detuvo EXACTO en el seleccionado
    const elegido = lista[index];

    if(i < 2){
      // 1er y 2Âº giro â†’ eliminado
      resultado.innerText = elegido.nombre + " - FUERA âŒ";
      hablar(elegido.nombre + " fuera");
      // Mostramos 3s el resultado SIN redibujar la ruleta con otra lista
      await sleep(3000);

      // Ahora sÃ­, eliminamos y guardamos
      lista.splice(index, 1);
      guardar();
      // No hace falta redibujar ahora; el siguiente giro repintarÃ¡.
    }else{
      // 3er giro â†’ ganador
      resultado.innerText = "ðŸ† " + elegido.nombre + " GANADOR ðŸŽ‰";
      hablar("Tenemos ganador. " + elegido.nombre, 0.8, 1.2);

      pantallaGanador.style.display = "flex";
      pantallaGanador.innerHTML = "ðŸ†<br>" + elegido.nombre;

      setTimeout(()=>{
        pantallaGanador.style.display="none";
      }, 6000);
    }
  }

  girando = false;
};
</script>

</body>
</html>
